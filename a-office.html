<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Executive & VIP Office Chairs | V-Best Interiors</title>
  <meta name="description" content="Shop premium executive and VIP office chairs at V-Best Interiors. Ergonomic, refined and built for long-lasting comfort and authority in the workplace.">
  <meta name="keywords" content="executive office chair, VIP chair, CEO chair, officechair, office chair Nigeria, V-Best Interiors">
  <meta property="og:title" content="Executive & VIP Office Chairs - V'Best Interiors">
  <meta property="og:description" content="Discover a curated selection of executive office chairs ‚Äî luxurious materials, excellent ergonomics and timeless design.">
  <meta property="og:image" content="https://i.postimg.cc/yNXsb9Q8/IMG-20250822-WA0058.jpg">
  <meta property="og:url" content="https://vbest-site.vercel.app/a-office.html">
  <meta name="twitter:card" content="summary_large_image">

  <style>
    :root {
      --bg: #ffffff;
      --card: #f8f8f8;
      --text: #111827;
      --accent: #1f2937; /* dark heading color */
      --btn: #FF9900;
      --btn-text: #fff;
      --price: #B12704;
      --green: #27ae60;
      --whatsapp: #25D366;
    }
    body[data-theme="classic"]{
      --bg:#ffffff; --card:#f8f8f8; --text:#111827; --accent:#1f2937; --btn:#FF9900; --btn-text:#fff; --price:#B12704; --green:#27ae60; --whatsapp:#25D366;
    }
    body[data-theme="dark"]{
      --bg:#0f1111; --card:#131921; --text:#fff; --accent:#FF9900; --btn:#FF9900; --btn-text:#fff; --price:#FF9900; --green:#25D366; --whatsapp:#25D366;
    }
    body[data-theme="gold"]{
      --bg:#fff8e7; --card:#fff3d6; --text:#2e2e2e; --accent:#c89200; --btn:#d4a017; --btn-text:#fff; --price:#c47800; --green:#27ae60; --whatsapp:#25D366;
    }

    html,body{height:100%; margin:0; padding:0; box-sizing:border-box;}
    body{
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      text-align:center;
      padding-bottom:84px; /* space for bottom nav */
    }

    /* top media (image or video) full-width */
    .top-media { width:100%; display:block; max-height:220px; overflow:hidden; background:transparent; }
    .logo-media { width:100%; height:auto; display:block; object-fit:cover; max-height:200px; }

    h1{ margin:8px 0 4px; font-size:20px; color:var(--accent); }
    #count{ font-size:14px; color:var(--green); margin-bottom:8px; font-weight:700; }

    /* product grid */
    .product-grid{
      display:grid;
      /* mobile-first: 2 columns on mobile/tablet/laptops by default */
      grid-template-columns: repeat(2,1fr);
      gap:10px;
      padding:10px;
      max-width:1100px;
      margin:0 auto;
      box-sizing:border-box;
    }

    /* desktop: 3 columns */
    @media (min-width: 1024px) {
      .product-grid{
        grid-template-columns: repeat(3,1fr);
      }
    }

    .product-card{
      background:var(--card);
      border-radius:10px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:320px;
      text-align:left;
    }
    .thumb{ width:100%; height:180px; background:#222; display:block; overflow:hidden; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; cursor:pointer; }

    .product-body{ padding:10px; display:flex; flex-direction:column; flex:1; }
    .product-body h3{ margin:0 0 6px; font-size:15px; color:var(--text); }
    .price-row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
/* clear, consistent colors for prices and timer */
    .old-price{
      text-decoration:line-through;
      color:#B12704;            /* red for the old price */
      font-weight:700;
      font-size:13px;
    }
    .price{
      color:#27ae60;            /* green for the new / discount price */
      font-weight:800;
      font-size:14px;
    }
    .discount-timer{
      color:#FF9900;            /* orange for ‚ÄúOffer ends in‚Äù */
      font-weight:700;
      font-size:14px;
      margin-top:6px;
    }
    .stars{ color:#ffd54a; margin:8px 0; font-size:14px; }

    .negotiable-badge-card { color:var(--green); font-weight:700; font-size:13px; margin-bottom:6px; }

    .btn-row{ display:flex; justify-content:space-between; gap:8px; margin-top:auto; }
    .btn-row a, .btn-row button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex: 1 1 48%;
      padding:10px;
      border-radius:8px;
      border:0;
      font-weight:700;
      cursor:pointer;
      text-decoration:none;
      color:var(--btn-text);
    }
    .inquiry-btn{ background:var(--whatsapp); color:#fff; text-decoration:none; }
    .buy-btn{ background:var(--btn); color:var(--btn-text); }
    .buy-btn[disabled]{ opacity:0.55; cursor:not-allowed; }

    /* details overlay */
    .details-panel{
      position:fixed; inset:0; display:none; align-items:flex-start; justify-content:center;
      background: rgba(0,0,0,0.9); z-index:99999; padding:18px; box-sizing:border-box; overflow:auto;
    }
    .details-inner{
      width:100%; max-width:1100px; background:var(--card); color:var(--text);
      border-radius:10px; padding:18px; display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap; position:relative;
      max-height: calc(100vh - 40px); overflow:auto;
    }
    .details-left{ flex:1 1 420px; text-align:center; background:transparent; }
    .details-left .main-image{ max-width:100%; max-height: calc(100vh - 220px); object-fit:contain; border-radius:8px; display:block; margin:0 auto; }
    .thumbs{ display:flex; gap:8px; margin-top:12px; overflow:auto; justify-content:center; padding-bottom:6px; }
    .thumbs img{ width:72px; height:56px; object-fit:cover; border-radius:6px; }
    .img-nav{ position:absolute; top:50%; transform:translateY(-50%); font-size:26px; color:#fff; background:rgba(0,0,0,0.3); padding:8px 10px; border-radius:8px; cursor:pointer; user-select:none; }
    .img-nav.left{ left:8px; } .img-nav.right{ right:8px; }

    .details-right{ flex:1 1 360px; text-align:left; }
    .details-right h2{ margin:0 0 8px; font-size:22px; color:var(--accent); }
    .details-right .desc{ margin-top:12px; line-height:1.6; color:var(--text); }

    .details-actions{ display:flex; justify-content:space-between; gap:10px; margin-top:12px; }

    .close-btn{ position:absolute; right:18px; top:12px; background:transparent; border:2px solid rgba(0,0,0,0.08); color:var(--text); padding:6px 10px; border-radius:8px; cursor:pointer; }

    /* bottom nav (always visible) */
    .bottom-nav{
      position:fixed; left:0; right:0; bottom:0; z-index:99998; height:64px;
      display:flex; justify-content:space-around; align-items:center; background:var(--card);
      border-top:1px solid rgba(0,0,0,0.06); box-shadow:0 -6px 18px rgba(0,0,0,0.08); padding:6px 10px;
    }
    .bottom-nav a, .bottom-nav button{
      background:transparent; border:0; font-size:16px; color:var(--accent); font-weight:700; cursor:pointer;
      display:flex; align-items:center; gap:8px;
    }
    .cart-badge{ background:#ff3b30; color:#fff; border-radius:50%; padding:2px 7px; font-size:12px; margin-left:6px; display:inline-block; }

    @media (max-width:420px){
      .product-grid{ grid-template-columns: 1fr 1fr; gap:8px; padding:8px; }
      .logo-media{ max-height:120px; object-fit:cover; }
      .details-inner{ padding:12px; max-height: calc(100vh - 20px); }
      .details-left .main-image{ max-height: calc(100vh - 160px); }
    }
  </style>
  <!-- Facebook Pixel Code --><script>!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script','https://connect.facebook.net/en_US/fbevents.js'); fbq('init', '677322691667443'); fbq('track', 'PageView');</script><noscript> <img height="1" width="1" src="https://www.facebook.com/tr?id=677322691667443&ev=PageView&noscript=1"/></noscript><!-- End Facebook Pixel Code -->
</head>
<body data-theme="classic">

  <!-- logo -->
  <div class="top-media" aria-hidden="false">
    <img src="images/logo.png" alt="V'Best Interiors logo" class="logo-media">
  </div>

  <h1>Executive & VIP Office Chairs</h1>
  <div id="count"><span class="spinner" aria-hidden="true"></span> Loading products...</div>

  <div id="products" class="product-grid" aria-live="polite"></div>

  <a href="chair.html" class="back" style="display:block;margin:14px 0;color:var(--accent);text-decoration:none;font-weight:700;">‚¨Ö Back to Categories</a>

  <!-- DETAILS PANEL -->
  <div id="detailsPanel" class="details-panel" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="details-inner" role="document">
      <button id="detailsClose" class="close-btn" aria-label="Close details">‚úï</button>
      <div class="details-left" id="detailsLeft"></div>
      <div class="details-right" id="detailsRight"></div>
    </div>
  </div>

  <!-- bottom nav -->
  <div class="bottom-nav" role="navigation" aria-label="Main navigation">
    <a href="index.html" id="nav-home">üè† Home</a>
    <button id="themeSwitch">üé® Theme</button>
    <a href="cart.html" id="nav-cart">üõí Cart <span id="cart-count-bottom" class="cart-badge" style="display:none">0</span></a>
  </div>

  <script>
    /***** CONFIG - replace this CSV if you have a different published sheet *****/
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4YXFvxl_w447wVuWRrHv8EInZFg1lSIX2_KwxZQJL9n8YHEzIP5WmfBep4yBgfN7EbArsjPPHOzOh/pub?output=csv";
    const FETCH_TIMEOUT_MS = 10000; // 10s fetch timeout (prevents indefinite "Loading...")
    const DISCOUNT_DURATION_MS = 30 * 24 * 60 * 60 * 1000; // 60 days - used only for timers display

    /***** UTILITIES *****/
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function escJS(s){ return String(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\n/g,'\\n').replace(/\r/g,''); }
    function normKey(k){ return String(k||'').toLowerCase().replace(/[^a-z0-9]/g,''); }

    // CSV row parser that supports quoted values
    function parseCSVRow(text){
      const fields = []; let cur=''; let inQuotes=false;
      for (let i=0;i<text.length;i++){
        const ch = text[i];
        if (inQuotes){
          if (ch === '"'){
            if (text[i+1] === '"'){ cur += '"'; i++; } else { inQuotes = false; }
          } else cur += ch;
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ','){ fields.push(cur); cur = ''; }
          else cur += ch;
        }
      }
      fields.push(cur);
      return fields;
    }

    function findIndexByNames(headerMap, candidates){
      for (const c of candidates){
        const k = normKey(c);
        if (headerMap[k] !== undefined) return headerMap[k];
      }
      return -1;
    }

    function parseNumber(s){
      if (!s) return NaN;
      const n = String(s).replace(/[^\d.-]/g,'');
      return n==='' ? NaN : parseFloat(n);
    }
    function formatNaira(n){ if (isNaN(n)) return ''; return '‚Ç¶' + Math.round(n).toLocaleString(); }

    /***** DOM refs & state *****/
    const countEl = document.getElementById('count');
    const container = document.getElementById('products');
    const detailsPanel = document.getElementById('detailsPanel');
    const detailsLeft = document.getElementById('detailsLeft');
    const detailsRight = document.getElementById('detailsRight');
    const detailsClose = document.getElementById('detailsClose');
    const bottomNav = document.querySelector('.bottom-nav');
    const cartBadge = document.getElementById('cart-count-bottom');
    const themeBtn = document.getElementById('themeSwitch');

    let products = [];
    let detailsOpenIndex = null;
    let currentImageIndex = 0;
    let pushedState = false;
    let ignorePopstate = false;

    /***** fetch with timeout *****/
    async function fetchWithTimeout(url, ms){
      const controller = new AbortController();
      const id = setTimeout(()=> controller.abort(), ms);
      try {
        const resp = await fetch(url, { signal: controller.signal });
        clearTimeout(id);
        if (!resp.ok) throw new Error('Network response was not ok: ' + resp.status);
        return await resp.text();
      } catch (err) {
        clearTimeout(id);
        throw err;
      }
    }

    /***** load products *****/
    (async function loadProducts(){
      try {
        console.log('Fetching CSV from', SHEET_CSV);
        const csv = await fetchWithTimeout(SHEET_CSV, FETCH_TIMEOUT_MS);
        console.log('CSV loaded, bytes:', csv.length);
        const text = csv.replace(/^\uFEFF/,'');
        const lines = text.split(/\r?\n/).filter(l=>l.trim() !== '');
        if (!lines.length) {
          countEl.innerHTML = 'No data found in sheet.';
          console.warn('CSV is empty after trimming.');
          return;
        }

        // build normalized header map
        const headerCols = parseCSVRow(lines[0]);
        const headerMap = {};
        headerCols.forEach((h,i)=> headerMap[normKey(h)] = i);

        // detect columns robustly (accept many variations)
        const categoryIdx = findIndexByNames(headerMap, ['category','cat','type','group','categoryname']);
        const nameIdx     = findIndexByNames(headerMap, ['productname','product','name','title','item']);
        const descIdx     = findIndexByNames(headerMap, ['description','desc','details','longdescription']);
        const priceIdx    = findIndexByNames(headerMap, ['price','priceraw','amount','cost']);
        const discountIdx = findIndexByNames(headerMap, ['discountprice','discount','offer','specialprice']);
        const negotiableIdx = findIndexByNames(headerMap, ['negotiable','neg','isnegotiable']);
        const imageIdx    = findIndexByNames(headerMap, ['imagelink','imagelinks','image','imageurl','image1','images','photo','photos']);
        const viewsIdx    = findIndexByNames(headerMap, ['views','rating','stars']);

        console.log('Column indexes:', { categoryIdx,nameIdx,descIdx,priceIdx,discountIdx,imageIdx });

        // parse each row
        for (let i=1; i<lines.length; i++){
          const cols = parseCSVRow(lines[i]);
          if (!cols || cols.length === 0) continue;
          const get = idx => (idx >= 0 && typeof cols[idx] !== 'undefined') ? String(cols[idx]).trim() : '';

          const category = get(categoryIdx);
          const name = get(nameIdx);
          const description = get(descIdx);
          const priceStr = get(priceIdx);
          const discountStr = get(discountIdx);
          const negotiable = get(negotiableIdx);
          const imageField = get(imageIdx);
          const viewsRaw = get(viewsIdx);

          const catNorm = (category||'').toLowerCase();
          // filter: only items whose category contains 'officechair'
          if (!catNorm.includes('officechair')) continue;

          const rawImgs = String(imageField || '').replace(/^"|"$/g,'');
          const imageLinks = rawImgs.split(/[\r\n,]+/).map(s=>s.trim()).filter(Boolean);
          const cleaned = imageLinks.filter(u => u && u.toLowerCase() !== 'sold');
          const hasImage = cleaned.length > 0;
          const firstImage = hasImage ? cleaned[0] : '';

          const priceNum = parseNumber(priceStr);
          const discNum = parseNumber(discountStr);
          const hasDiscount = !(String(discountStr||'').trim().toLowerCase()==='no' || String(discountStr||'').trim()==='') && !isNaN(discNum);
          const saveNum = (hasDiscount && !isNaN(priceNum)) ? (priceNum - discNum) : NaN;

          const stars = (viewsRaw && viewsRaw.trim() !== '') ? (function(){ let p = parseInt(viewsRaw,10); if (isNaN(p)) p = 5; p = Math.max(1,Math.min(5,p)); return Array.from({length:5},(_,k)=>k<p?'‚òÖ':'‚òÜ').join(''); })() : '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ';

          const product = {
            name, category, description, priceStr, discountStr, negotiable,
            imageLinks: cleaned, hasImage, firstImage, priceNum, discNum, hasDiscount, saveNum, stars
          };

          // countdown (purely cosmetic)
          if (!isNaN(product.priceNum)){
            product._durationMs = DISCOUNT_DURATION_MS;
            product._endTime = Date.now() + product._durationMs;
            product._hasCountdown = true;
          } else product._hasCountdown = false;

          products.push(product);
        }

        console.log('Filtered products count (officechair):', products.length);
        countEl.innerHTML = `Total Executive Chairs Available: ${products.length}`;

        if (products.length === 0){
          // helpful hint for common mistakes
          countEl.innerHTML = 'No products found in category "officechair". Make sure the Category column contains the exact word: <strong>officechair</strong> (no space) or a value that includes it (case-insensitive).';
          return;
        }

        renderGrid();
        updateCartCount();
      } catch (err) {
        console.error('Failed to load CSV:', err);
        // give the user a concise, actionable error
        if (err.name === 'AbortError'){
          countEl.innerHTML = 'Failed to load products: request timed out. Make sure the Google Sheet is published to the web and the CSV URL is correct.';
        } else {
          countEl.innerHTML = 'Failed to load products. Check your SHEET_CSV link and that the sheet is published (File ‚Üí Publish to web ‚Üí CSV).';
        }
      }
    })();

    /***** render grid *****/
    function renderGrid(){
      container.innerHTML = '';
      products.forEach((p, idx) => {
        const inquiryHref = 'https://wa.me/2347080535579?text=' + encodeURIComponent(`Hello, I'm interested in ${p.name} priced at ${ p.hasDiscount ? p.discountStr : p.priceStr }.`);
        const addDisabled = p.hasImage ? '' : 'disabled';
        const imageArg = p.hasImage ? escJS(p.firstImage) : '';
        const imgHtml = p.hasImage
          ? `<span class="thumb" onclick="openDetails(${idx})" role="button" aria-label="Open ${escapeHtml(p.name)}"><img src="${escapeHtml(p.firstImage)}" alt="${escapeHtml(p.name)}"></span>`
          : `<span class="thumb" onclick="openDetails(${idx})" role="button" aria-label="Open ${escapeHtml(p.name)}"><div style="width:100%;height:180px;display:flex;align-items:center;justify-content:center;background:#fff;color:#ff3b30;font-weight:800;font-size:10px;">Currently out of stock ‚Äî please check back soon!</div></span>`;

        const priceHtml = p.hasDiscount ? `<div class="old-price">${escapeHtml(p.priceStr)}</div><div class="price">${escapeHtml(p.discountStr)}</div>` : `<div class="price">${escapeHtml(p.priceStr)}</div>`;
        const saveHtml = (p.hasDiscount && !isNaN(p.saveNum) && p.saveNum>0) ? `<div class="save-amount">Save ${formatNaira(p.saveNum)}</div>` : '';

        const card = document.createElement('div');
        card.className = 'product-card';
        card.setAttribute('role','article');
        card.innerHTML = `
          ${imgHtml}
          <div class="product-body">
            <a style="text-decoration:none;color:inherit;" onclick="openDetails(${idx})"><h3>${escapeHtml(p.name)}</h3></a>
            <div class="meta-small">Category: ${escapeHtml(p.category || 'Executive')}</div>
            <div class="price-row">${priceHtml}${saveHtml}</div>
            <div class="discount-timer" data-product-index="${idx}"></div>
            <div class="stars">${escapeHtml(p.stars)}</div>
            ${(p.negotiable && ['yes','y','true','1','negotiable'].includes(String(p.negotiable).trim().toLowerCase())) ? '<div style="color:var(--green);font-weight:600;">Negotiable</div>' : ''}
            <div class="btn-row">
              <a class="inquiry-btn" href="${escapeHtml(inquiryHref)}" target="_blank" rel="noopener noreferrer">üì© Inquiry</a>
              <button class="buy-btn" ${addDisabled} onclick="addToCart('${escJS(p.name)}','${escJS(p.hasDiscount?p.discountStr:p.priceStr)}','${imageArg}')">üõí Add to Cart</button>
            </div>
          </div>`;
        container.appendChild(card);
      });
    }

    /***** Cart functions *****/
    function addToCart(name, price, image){
      try{
        let cart = JSON.parse(localStorage.getItem('cart')||'[]');
        cart.push({ name, price, image, qty:1 });
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
      } catch (e){ console.error('addToCart error', e); }
    }
    function updateCartCount(){
      const cart = JSON.parse(localStorage.getItem('cart')||'[]');
      if (cart.length>0){ cartBadge.style.display='inline-block'; cartBadge.textContent = cart.length; } else cartBadge.style.display='none';
    }

    /***** countdown updater for product cards and details *****/
    setInterval(()=> {
      const now = Date.now();
      document.querySelectorAll('.discount-timer').forEach(el=>{
        const idx = parseInt(el.dataset.productIndex, 10);
        const p = products[idx];
        if (!p || !p._hasCountdown) return;
        let timeLeft = p._endTime - now;
        if (timeLeft <= 0){ p._endTime = Date.now() + p._durationMs; timeLeft = p._endTime - Date.now(); }
        el.textContent = 'Offer ends in: ' + formatTimeRemaining(timeLeft);
      });
      const dTimer = document.getElementById('details-timer');
      if (dTimer && detailsOpenIndex !== null){
        const p = products[detailsOpenIndex];
        if (p && p._hasCountdown){
          let t = p._endTime - now;
          if (t <= 0){ p._endTime = Date.now() + p._durationMs; t = p._endTime - Date.now(); }
          dTimer.textContent = 'Offer ends in: ' + formatTimeRemaining(t);
        }
      }
    }, 1000);

    function formatTimeRemaining(ms){
      if (isNaN(ms) || ms <= 0) return '0s';
      const total = Math.floor(ms/1000);
      const days = Math.floor(total/86400);
      const hours = Math.floor((total%86400)/3600);
      const mins = Math.floor((total%3600)/60);
      const secs = total%60;
      return `${days}d ${hours}h ${mins}m ${secs}s`;
    }

    /***** DETAILS PANEL (gallery + info) with Back button behavior *****/
    detailsClose.addEventListener('click', ()=> closeDetails());
    function openDetails(idx){
      if (typeof idx !== 'number' || !products[idx]) return;
      detailsOpenIndex = idx;
      currentImageIndex = 0;
      renderDetails(products[idx]);
      detailsPanel.style.display = 'flex';
      detailsPanel.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
      bottomNav.style.display = 'none';
      document.addEventListener('keydown', detailsKeyHandler);

      // push state so Back closes details instead of leaving page
      try {
        history.pushState({ vbest:'details', idx: idx }, '', '#product-' + idx);
        pushedState = true;
      } catch(e){ /* ignore */ }
    }
    function closeDetails(fromPopstate = false){
      detailsPanel.style.display = 'none';
      detailsPanel.setAttribute('aria-hidden','true');
      detailsLeft.innerHTML = '';
      detailsRight.innerHTML = '';
      detailsOpenIndex = null;
      currentImageIndex = 0;
      document.body.style.overflow = '';
      bottomNav.style.display = '';
      document.removeEventListener('keydown', detailsKeyHandler);

      // if we pushed a state, go back to remove it (unless popstate already handled it)
      if (pushedState && !fromPopstate){
        ignorePopstate = true;
        try { history.back(); } catch(e){ /* ignore */ }
      }
      pushedState = false;
    }
    function detailsKeyHandler(e){
      if (e.key === 'Escape') closeDetails();
      if (e.key === 'ArrowLeft') showImageIndex(-1);
      if (e.key === 'ArrowRight') showImageIndex(1);
    }
    window.addEventListener('popstate', (event) => {
      if (ignorePopstate){ ignorePopstate = false; return; }
      if (detailsPanel.style.display === 'flex') {
        closeDetails(true);
      }
    });

    function renderDetails(p){
      const mainImg = p.hasImage ? `<img id="detailsMainImage" class="main-image" src="${escapeHtml(p.imageLinks[0])}" alt="${escapeHtml(p.name)}">` : `<div style="width:100%;height:60vh;display:flex;align-items:center;justify-content:center;background:#111;color:#fff;font-weight:800;font-size:20px;border-radius:8px;">No image available</div>`;
      const hasMultiple = p.imageLinks && p.imageLinks.length > 1;
      const leftArrow = hasMultiple ? `<div class="img-nav left" id="imgPrev">‚Äπ</div>` : '';
      const rightArrow = hasMultiple ? `<div class="img-nav right" id="imgNext">‚Ä∫</div>` : '';
      let thumbsHtml = '';
      if (p.imageLinks && p.imageLinks.length){
        thumbsHtml = '<div class="thumbs" id="thumbsContainer">';
        p.imageLinks.forEach((u,i)=> thumbsHtml += `<button data-idx="${i}" class="thumb-btn" style="border:2px solid transparent;background:transparent;padding:0;margin:0;"><img src="${escapeHtml(u)}" alt="thumb ${i+1}"></button>`);
        thumbsHtml += '</div>';
      }
      detailsLeft.innerHTML = `${leftArrow}${mainImg}${rightArrow}${thumbsHtml}`;

      if (hasMultiple){
        document.getElementById('imgPrev').addEventListener('click', ()=> showImageIndex(-1));
        document.getElementById('imgNext').addEventListener('click', ()=> showImageIndex(1));
      }
      const thumbsContainer = document.getElementById('thumbsContainer');
      if (thumbsContainer){
        thumbsContainer.querySelectorAll('button.thumb-btn').forEach(btn => btn.addEventListener('click', ()=> { goToImage(parseInt(btn.getAttribute('data-idx'),10)); }));
        highlightThumb(currentImageIndex);
      }
      const main = document.getElementById('detailsMainImage');
      if (main){
        let touchStartX = null;
        main.addEventListener('touchstart', (ev)=> { touchStartX = ev.touches[0].clientX; }, {passive:true});
        main.addEventListener('touchend', (ev)=> {
          if (touchStartX===null) return;
          const endX = ev.changedTouches[0].clientX; const diff = endX - touchStartX;
          if (Math.abs(diff) > 40){ if (diff < 0) showImageIndex(1); else showImageIndex(-1); }
          touchStartX = null;
        }, {passive:true});
      }

      const saveHtml = (p.hasDiscount && !isNaN(p.saveNum) && p.saveNum>0) ? `<div class="save-amount">Save ${formatNaira(p.saveNum)}</div>` : '';
      const negotiableHtml = (p.negotiable && ['yes','y','true','1','negotiable'].includes(String(p.negotiable).trim().toLowerCase())) ? `<div class="negotiable">Negotiable</div>` : '';
      const priceHtml = p.hasDiscount ? `<div class="old-price">${escapeHtml(p.priceStr)}</div><div class="price">${escapeHtml(p.discountStr)}</div>` : `<div class="price">${escapeHtml(p.priceStr)}</div>`;
      const inquiryHref = 'https://wa.me/2347080535579?text=' + encodeURIComponent(`Hello, I'm interested in ${p.name} priced at ${ p.hasDiscount ? p.discountStr : p.priceStr }.`);
      const detailsTimerHtml = p._hasCountdown ? `<div id="details-timer" class="discount-timer">Offer ends in: --d --h --m --s</div>` : '';

      detailsRight.innerHTML = `
        <h2>${escapeHtml(p.name)}</h2>
        <div class="meta-small">Category: ${escapeHtml(p.category || '')}</div>
        <div class="price-row">${priceHtml} ${saveHtml}</div>
        ${detailsTimerHtml}
        ${negotiableHtml}
        <div class="stars">${escapeHtml(p.stars)}</div>
        <div class="details-actions">
          <a class="inquiry-btn" href="${escapeHtml(inquiryHref)}" target="_blank" rel="noopener noreferrer">üì© Inquiry on WhatsApp</a>
          <button class="buy-btn" ${p.hasImage ? '' : 'disabled'} onclick="addToCart('${escJS(p.name)}','${escJS(p.hasDiscount?p.discountStr:p.priceStr)}','${escJS(p.hasImage?p.firstImage:'')}')">üõí Add to Cart</button>
        </div>
        <div class="desc"><h3 style="margin-top:14px;color:var(--accent);">Product description</h3><p style="margin:8px 0 0;line-height:1.6;color:var(--text);">${escapeHtml(p.description || 'No description available.')}</p></div>
      `;
      // initial details timer
      if (p._hasCountdown){
        const now = Date.now(); let timeLeft = p._endTime - now; if (timeLeft <= 0){ p._endTime = Date.now() + p._durationMs; timeLeft = p._endTime - Date.now(); }
        const dt = document.getElementById('details-timer'); if (dt) dt.textContent = 'Offer ends in: ' + formatTimeRemaining(timeLeft);
      }
    }

    function showImageIndex(delta){
      if (detailsOpenIndex === null) return;
      const p = products[detailsOpenIndex]; if (!p || !p.imageLinks || !p.imageLinks.length) return;
      currentImageIndex = (currentImageIndex + delta + p.imageLinks.length) % p.imageLinks.length;
      const main = document.getElementById('detailsMainImage'); if (main) main.src = p.imageLinks[currentImageIndex];
      highlightThumb(currentImageIndex);
    }
    function goToImage(i){
      if (detailsOpenIndex === null) return;
      const p = products[detailsOpenIndex]; if(!p||!p.imageLinks||!p.imageLinks[i]) return;
      currentImageIndex = i;
      const main = document.getElementById('detailsMainImage'); if (main) main.src = p.imageLinks[currentImageIndex];
      highlightThumb(currentImageIndex);
    }
    function highlightThumb(i){
      const thumbs = document.querySelectorAll('#thumbsContainer button.thumb-btn');
      thumbs.forEach((b,idx)=> b.style.border = (idx===i)?'2px solid var(--green)':'2px solid transparent');
      const sel = thumbs[i]; if (sel && sel.scrollIntoView) sel.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
    }

    /* THEME SWITCHER (simple cycle) */
    (function(){
      const themes = ['classic','dark','gold'];
      let current = localStorage.getItem('vbest_theme') || 'classic';
      if (!themes.includes(current)) current = 'classic';
      document.body.setAttribute('data-theme', current);
      let idx = themes.indexOf(current);
      themeBtn.addEventListener('click', ()=> {
        idx = (idx + 1) % themes.length;
        const t = themes[idx];
        document.body.setAttribute('data-theme', t);
        localStorage.setItem('vbest_theme', t);
      });
    })();

    /* close details on backdrop click */
    detailsPanel.addEventListener('click', function(e){ if (e.target === detailsPanel) closeDetails(); });

    /* sync cart across tabs */
    window.addEventListener('storage', (e)=> { if (e.key === 'cart') updateCartCount(); });

  </script>
</body>
</html>