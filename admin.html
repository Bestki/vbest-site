<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - Orders</title>
  <style>
    :root{
      --bg:#000; --panel:#111; --muted:#bbb; --accent:#27ae60; --danger:#ff3b30; --card:#1a1a1a;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#fff}
    header{padding:18px;display:flex;align-items:center;gap:12px;justify-content:space-between;background:var(--panel)}
    header h1{margin:0;font-size:18px}
    .top-actions{display:flex;gap:8px;align-items:center}
    button, input, select, textarea{font-family:inherit}
    .btn{background:var(--accent);color:#000;padding:8px 10px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .btn.secondary{background:#333;color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    .container{padding:16px;max-width:1100px;margin:18px auto}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .controls input[type="text"]{padding:8px;border-radius:8px;border:1px solid #333;background:#111;color:#fff}
    .orders{display:grid;grid-template-columns:1fr;gap:12px}
    .order{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.5);display:flex;flex-direction:column;gap:8px}
    .order-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .meta{color:var(--muted);font-size:13px}
    .items{background:#0f0f0f;padding:8px;border-radius:6px;display:flex;flex-direction:column;gap:6px;font-size:14px}
    .items .item-row{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .items img{width:64px;height:64px;object-fit:cover;border-radius:6px;cursor:pointer}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:13px;color:var(--muted)}
    label{font-size:13px;color:var(--muted);display:block;margin-top:6px}
    .status-pill{padding:6px 8px;border-radius:999px;font-weight:700}
    .status-pending{background:#ffd54d;color:#000}
    .status-approved{background:#27ae60;color:#fff}
    .status-declined{background:#e74c3c;color:#fff}
    .status-paid{background:#009688;color:#fff}
    footer{padding:12px;text-align:center;color:var(--muted)}
    @media (min-width:880px){ .orders{grid-template-columns:1fr 1fr} }

    /* lightbox */
    .lightbox { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; padding:20px; box-sizing:border-box; }
    .lightbox img { max-width:100%; max-height:80vh; border-radius:8px; object-fit:contain; }
    .lightbox .caption { color:#fff; margin-top:8px }
  </style>
</head>
<body>

  <header>
    <h1>Admin — Orders</h1>
    <div class="top-actions">
      <div id="pendingCount" class="small">Pending: 0</div>
      <button id="btn-refresh" class="btn secondary">Refresh</button>
      <button id="btn-clear" class="btn danger">Clear All</button>
      <button id="btn-logout" class="btn secondary">Logout</button>
    </div>
  </header>

  <div class="container">
    <div class="controls">
      <input type="text" id="search" placeholder="Search by customer, product or order key">
      <select id="filter">
        <option value="all">All</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="declined">Declined</option>
        <option value="paid">Paid</option>
      </select>
      <button id="toggleNotify" class="btn">Enable Notifications</button>
    </div>

    <div id="orders" class="orders" aria-live="polite"></div>

    <footer>
      Tip: Approve items, paste a payment link (or create one) and use "Send Payment Request" to message the customer on WhatsApp.
    </footer>
  </div>

  <!-- lightbox -->
  <div id="lightbox" class="lightbox" onclick="this.style.display='none'">
    <div>
      <img id="lightbox-img" src="">
      <div class="caption" id="lightbox-caption"></div>
    </div>
  </div>

  <script type="module">
    /*************** CONFIG - your admin password (DO NOT change unless you want to) ****************/
    const ADMIN_PASSWORD = "best22**22";
    /***********************************************************************************************/

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAF_Fy32TmyNOAYebcRCcOLhgcKn82Xavs",
      authDomain: "v-best-luxury-interiors.firebaseapp.com",
      databaseURL: "https://v-best-luxury-interiors-default-rtdb.firebaseio.com",
      projectId: "v-best-luxury-interiors",
      storageBucket: "v-best-luxury-interiors.firebasestorage.app",
      messagingSenderId: "331900870737",
      appId: "1:331900870737:web:c100c6a2987345eb955870",
      measurementId: "G-NP94R6352Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const ordersRef = ref(db, 'orders');

    // UI refs
    const ordersEl = document.getElementById('orders');
    const searchEl = document.getElementById('search');
    const filterEl = document.getElementById('filter');
    const pendingCountEl = document.getElementById('pendingCount');
    const notifyBtn = document.getElementById('toggleNotify');
    const refreshBtn = document.getElementById('btn-refresh');
    const logoutBtn = document.getElementById('btn-logout');
    const clearBtn = document.getElementById('btn-clear');

    // state
    let allOrders = {};
    let notificationsEnabled = false;
    let firstLoad = true;

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type="sine"; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.value=0.04;
        o.start(); setTimeout(()=>{ o.stop(); ctx.close(); },180);
      } catch(e){}
    }

    async function requestNotifications() {
      if (!("Notification" in window)) return false;
      if (Notification.permission === "granted") return true;
      const perm = await Notification.requestPermission(); return perm === "granted";
    }

    function notify(title, body) {
      if (!notificationsEnabled) return;
      if (Notification.permission === "granted") new Notification(title, { body });
      beep();
    }

    function formatPhoneForWa(raw) {
      if (!raw) return "";
      const digits = raw.replace(/\D/g,"");
      if (!digits) return "";
      if (digits.length === 10 && digits.startsWith("0")) return "234" + digits.slice(1);
      return digits;
    }

    // open image lightbox
    window.openImage = function(src, caption) {
      if (!src) return;
      document.getElementById('lightbox-img').src = src;
      document.getElementById('lightbox-caption').textContent = caption || '';
      document.getElementById('lightbox').style.display = 'flex';
    };

    function escapeHtml(s) {
      if (!s) return '';
      return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }

    // ---------- Render ----------
    function render() {
      const q = (searchEl.value || '').trim().toLowerCase();
      const filter = filterEl.value;
      ordersEl.innerHTML = '';

      const keys = Object.keys(allOrders).sort((a,b)=> {
        const at = allOrders[a]?.createdAt || 0; const bt = allOrders[b]?.createdAt || 0; return bt - at;
      });

      let pendingCount = 0;

      for (const key of keys) {
        const order = allOrders[key];
        if (!order) continue;

        // treat missing or null status as 'pending' (display-wise)
        const rawStatus = (order.status === undefined || order.status === null) ? 'pending' : String(order.status);
        const status = rawStatus.toLowerCase();

        if (status === 'pending') pendingCount++;

        if (filter !== 'all' && filter !== status) continue;

        const hay = (key + ' ' + (order.customer?.name||'') + ' ' + (order.customer?.phone||'') + ' ' + JSON.stringify(order.cart||[])).toLowerCase();
        if (q && !hay.includes(q)) continue;

        const created = order.createdAt ? new Date(order.createdAt) : null;
        const createdStr = created ? created.toLocaleString() : (order.createdAt || '');
        const statusClass = status === 'pending' ? 'status-pending' : status === 'approved' ? 'status-approved' : status === 'declined' ? 'status-declined' : status === 'paid' ? 'status-paid' : 'status-pending';
        const totalDisplay = (order.totalAmount !== undefined) ? ("₦" + Number(order.totalAmount).toLocaleString()) : (order.total || '');

        // build items with per-item controls and status
        let itemsHtml = '';
        let approvedTotal = 0;
        if (Array.isArray(order.cart)) {
          order.cart.forEach((it, idx) => {
            const nm = escapeHtml(it.name || it.product || 'Product');
            const qty = it.quantity || 1;
            const pr = Number(it.price || it.amount || 0) || 0;
            if ((it.status || 'pending').toString().toLowerCase() === 'approved') approvedTotal += pr * qty;
            const img = it.image ? `<img src="${escapeHtml(it.image)}" alt="${nm}" onclick="openImage('${escapeHtml(it.image)}','${nm}')">` : `<div style="width:64px;height:64px;background:#111;border-radius:6px;"></div>`;
            const itemStatus = (it.status || 'pending').toString().toLowerCase();
            const pill = itemStatus === 'approved' ? '<span style="color:#000;background:#27ae60;padding:4px 8px;border-radius:999px;font-weight:700">APPROVED</span>' : itemStatus === 'declined' ? '<span style="color:#fff;background:#e74c3c;padding:4px 8px;border-radius:999px;font-weight:700">DECLINED</span>' : '<span style="color:#000;background:#ffd54d;padding:4px 8px;border-radius:999px;font-weight:700">PENDING</span>';
            itemsHtml += `<div class="item-row">
              <div style="display:flex;gap:8px;align-items:center">
                ${img}
                <div style="text-align:left">
                  <strong>${nm}</strong>
                  <div class="small">Qty: ${qty} • ₦${pr.toLocaleString()}</div>
                </div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <div style="min-width:96px">${pill}</div>
                <div style="display:flex;gap:6px">
                  <button class="btn" data-action="approve-item" data-key="${escapeHtml(key)}" data-idx="${idx}">Approve</button>
                  <button class="btn secondary" data-action="decline-item" data-key="${escapeHtml(key)}" data-idx="${idx}">Decline</button>
                </div>
              </div>
            </div>`;
          });
        } else {
          itemsHtml = '<div class="small">No items</div>';
        }

        const paymentLink = order.paymentLink ? `<div class="small">Payment link: <a href="${escapeHtml(order.paymentLink)}" target="_blank" style="color:#9fd">${escapeHtml(order.paymentLink)}</a></div>` : "";

        const orderCard = document.createElement('div');
        orderCard.className = 'order';
        orderCard.innerHTML = `
          <div class="order-head">
            <div>
              <div style="font-weight:800">Order <span class="small" style="opacity:0.8">${escapeHtml(key)}</span></div>
              <div class="meta small">${escapeHtml(order.customer?.name||'Customer')} • ${escapeHtml(order.customer?.phone||'')} • ${escapeHtml(order.customer?.email||'')}</div>
              <div class="meta small">${createdStr}</div>
            </div>
            <div style="text-align:right">
              <div class="status-pill ${statusClass}">${status.toUpperCase()}</div>
              <div style="margin-top:8px;font-weight:700">${totalDisplay}</div>
              <div class="small" style="margin-top:6px">Approved Total: <strong>₦${Number(approvedTotal).toLocaleString()}</strong></div>
            </div>
          </div>

          <div class="items">${itemsHtml}</div>

          ${paymentLink}

          <div class="actions">
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <input type="text" placeholder="paste payment link" data-input-for="${escapeHtml(key)}" style="min-width:240px;padding:6px;border-radius:6px;border:1px solid #333;background:#111;color:#fff">
              <button class="btn" data-action="setlink" data-key="${escapeHtml(key)}">Save Link</button>
              <button class="btn secondary" data-action="sendwa" data-key="${escapeHtml(key)}">Send Payment Request (WA)</button>
              <button class="btn secondary" data-action="markpaid" data-key="${escapeHtml(key)}">Mark Paid</button>
              <button class="btn" data-action="approve-all" data-key="${escapeHtml(key)}">Approve All</button>
              <button class="btn danger" data-action="delete" data-key="${escapeHtml(key)}">Delete (remove)</button>
            </div>
          </div>
        `;
        orderCard.querySelectorAll('button[data-action]').forEach(btn => btn.addEventListener('click', onActionClick));
        ordersEl.appendChild(orderCard);
      }

      pendingCountEl.textContent = `Pending: ${pendingCount}`;
    }

    // ---------- Actions ----------
    async function onActionClick(e) {
      const act = e.currentTarget.getAttribute('data-action');
      const key = e.currentTarget.getAttribute('data-key');
      if (!key) return;
      try {
        if (act === 'approve-item' || act === 'decline-item') {
          const idx = Number(e.currentTarget.getAttribute('data-idx'));
          if (isNaN(idx)) return;
          const conf = true; // no confirmation (user requested instant)
          if (!conf) return;
          const snap = await get(ref(db, 'orders/' + key));
          const order = snap.val();
          if (!order) return alert('Order not found.');
          let newCart = Array.isArray(order.cart) ? order.cart.slice() : (order.cart ? Object.values(order.cart) : []);
          if (!newCart[idx]) return alert('Item not found.');
          newCart[idx].status = (act === 'approve-item') ? 'approved' : 'declined';
          newCart[idx].updatedAt = Date.now();
          const statuses = newCart.map(it => (it.status || 'pending').toLowerCase());
          let overall = 'pending';
          if (statuses.every(s => s === 'approved')) overall = 'approved';
          else if (statuses.every(s => s === 'declined')) overall = 'declined';
          else if (statuses.some(s => s === 'approved')) overall = 'partially_approved';
          const approvedTotal = newCart.reduce((sum,it)=> sum + ((it.status === 'approved') ? (Number(it.price||0) * Number(it.quantity||1)) : 0), 0);
          await update(ref(db, 'orders/' + key), { cart: newCart, status: overall, approvedTotal, updatedAt: Date.now() });
          alert('Item updated.');
        } else if (act === 'approve-all') {
          // Approve all pending items in this order, skip declined ones, leave approved ones
          const snap = await get(ref(db, 'orders/' + key));
          const order = snap.val();
          if (!order) return alert('Order not found.');
          let newCart = Array.isArray(order.cart) ? order.cart.slice() : (order.cart ? Object.values(order.cart) : []);
          if (!newCart.length) return alert('No items to approve.');
          let changed = 0;
          for (let i = 0; i < newCart.length; i++) {
            const cur = (newCart[i].status || 'pending').toString().toLowerCase();
            if (cur === 'pending') {
              newCart[i].status = 'approved';
              newCart[i].updatedAt = Date.now();
              changed++;
            }
            // skip 'declined' and leave 'approved' as-is
          }
          const statuses = newCart.map(it => (it.status || 'pending').toLowerCase());
          let overall = 'pending';
          if (statuses.every(s => s === 'approved')) overall = 'approved';
          else if (statuses.every(s => s === 'declined')) overall = 'declined';
          else if (statuses.some(s => s === 'approved')) overall = 'partially_approved';
          const approvedTotal = newCart.reduce((sum,it)=> sum + ((it.status === 'approved') ? (Number(it.price||0) * Number(it.quantity||1)) : 0), 0);
          await update(ref(db, 'orders/' + key), { cart: newCart, status: overall, approvedTotal, updatedAt: Date.now() });
          alert(`Approved ${changed} pending item(s) in this order.`);
        } else if (act === 'setlink') {
          const input = document.querySelector(`input[data-input-for="${key}"]`);
          if (!input) return alert('Input not found.');
          const url = input.value.trim();
          if (!url) return alert('Paste a payment link first.');
          await update(ref(db, 'orders/' + key), { paymentLink: url, paymentLinkSetAt: Date.now() });
          alert('Payment link saved to order.');
        } else if (act === 'sendwa') {
          const snap = await get(ref(db, 'orders/' + key));
          const order = snap.val();
          if (!order) return alert('Order not found');
          const phone = formatPhoneForWa(order.customer?.phone || '');
          const approvedItems = (order.cart || []).filter(i => (i.status || 'pending').toString().toLowerCase() === 'approved');
          if (approvedItems.length === 0) {
            if (!confirm('No approved items found. Do you still want to send a message?')) return;
          }
          let itemsText = approvedItems.map(it => `${it.name} x${it.quantity||1} (₦${Number(it.price||0).toLocaleString()})`).join('\n');
          const link = order.paymentLink || '';
          let message = `Hello ${order.customer?.name || ''}, your order ${key}:\n\n${itemsText}\n\nApproved total: ₦${Number(order.approvedTotal||0).toLocaleString()}\n`;
          if (link) message += `\nPay here: ${link}\n`;
          message += `\nReply if you have questions.`;
          if (!phone) return alert('Customer phone missing or invalid.');
          const waUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
          window.open(waUrl,'_blank');
          await update(ref(db, 'orders/' + key), { paymentRequestedAt: Date.now() });
        } else if (act === 'markpaid') {
          if (!confirm('Mark this order as PAID?')) return;
          await update(ref(db, 'orders/' + key), { status: 'paid', paidAt: Date.now() });
          alert('Order marked as paid.');
        } else if (act === 'delete') {
          if (!confirm('Delete this order from database? This cannot be undone.')) return;
          await remove(ref(db, 'orders/' + key));
          alert('Order deleted.');
        }
      } catch (err) {
        console.error('Action error', err);
        alert('Operation failed. See console for details.');
      }
    }

    // ---------- Clear processed orders ----------
    async function clearAllProcessed() {
      if (!confirm('Clear all processed orders? This will permanently delete all orders that are NOT PENDING (approved, declined, paid, partially_approved). Proceed?')) return;
      clearBtn.disabled = true;
      clearBtn.textContent = 'Clearing...';
      try {
        const keys = Object.keys(allOrders || {});
        const toDelete = keys.filter(k => {
          // treat missing/null status as 'pending' (keep them)
          const raw = (allOrders[k] && (allOrders[k].status === undefined || allOrders[k].status === null)) ? 'pending' : (allOrders[k] && allOrders[k].status) || '';
          const s = String(raw).toLowerCase();
          return s !== 'pending';
        });
        if (toDelete.length === 0) {
          alert('No processed orders to clear.');
          return;
        }
        const promises = toDelete.map(k => remove(ref(db, 'orders/' + k)).then(()=>k).catch(err => { console.error('delete failed', k, err); return null; }));
        const results = await Promise.all(promises);
        const deleted = results.filter(r => r).length;
        alert(`Cleared ${deleted} processed order(s).`);
      } catch (err) {
        console.error('clearAll error', err);
        alert('Error clearing orders. See console.');
      } finally {
        clearBtn.disabled = false;
        clearBtn.textContent = 'Clear All';
      }
    }

    // ---------- Real-time listening ----------
    function startListening() {
      onValue(ordersRef, (snap) => {
        const data = snap.val() || {};
        const prevKeys = new Set(Object.keys(allOrders || {}));
        allOrders = data;
        const currentKeys = Object.keys(data || {});
        if (!firstLoad) {
          for (const k of currentKeys) {
            if (!prevKeys.has(k)) {
              const o = data[k];
              // notify only for new pending orders (treat missing status as pending)
              const st = ((o && (o.status === undefined || o.status === null)) ? 'pending' : (o && o.status) || '').toString().toLowerCase();
              if (st === 'pending') notify('New order', `Order ${k} from ${o.customer?.name || 'customer'}`);
            }
          }
        }
        firstLoad = false;
        render();
      });
    }

    // ---------- Login gate ----------
    async function login() {
      try {
        const pw = prompt('Enter admin password:');
        if (!pw) return false;
        if (pw !== ADMIN_PASSWORD) { alert('Wrong password'); return false; }
      } catch(e) { return false; }
      const allowed = await requestNotifications();
      notificationsEnabled = allowed;
      notifyBtn.textContent = allowed ? 'Notifications: ON' : 'Enable Notifications';
      startListening();
      return true;
    }

    // ---------- UI bindings ----------
    notifyBtn.addEventListener('click', async () => {
      const allowed = await requestNotifications();
      notificationsEnabled = allowed;
      notifyBtn.textContent = allowed ? 'Notifications: ON' : 'Enable Notifications';
      alert('Notifications: ' + (allowed ? 'enabled' : 'blocked/unsupported'));
    });

    refreshBtn.addEventListener('click', () => render());
    logoutBtn.addEventListener('click', () => { if (confirm('Log out admin view?')) location.reload(); });
    clearBtn.addEventListener('click', clearAllProcessed);

    searchEl.addEventListener('input', () => render());
    filterEl.addEventListener('change', () => render());

    (async () => {
      const ok = await login();
      if (!ok) {
        document.body.innerHTML = '<div style="padding:40px;text-align:center">Not authorized. Reload to try again.</div>';
      }
    })();
  </script>
</body>
</html>