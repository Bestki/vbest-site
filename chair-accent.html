<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title> Chairs - Vâ€™Best Luxury Interiors</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #000;
      color: #fff;
      text-align: center;
      position: relative;
    }
    h1 {
      padding: 15px 0;
      margin: 0;
    }
    #count {
      font-size: 16px;
      font-weight: bold;
      margin: 10px 0;
      color: #27ae60;
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      padding: 10px;
    }
    .product-card {
      background: #111;
      border-radius: 8px;
      overflow: hidden;
      padding-bottom: 10px;
    }
    .product-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      cursor: pointer;
      display: block;
    }
    /* SOLD placeholder when no image or image = "sold" */
    .product-card .sold {
      width: 100%;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ffffff;   /* white so clearly visible */
      color: #ff3b30;        /* red SOLD text */
      font-weight: 800;
      font-size: 28px;
      letter-spacing: 2px;
    }
    .product-card h3 {
      font-size: 15px;
      margin: 8px 0 4px;
    }
    .price {
      font-size: 14px;
      font-weight: bold;
      color: #27ae60;
      margin: 2px 0;
    }
    .old-price {
      text-decoration: line-through;
      color: #ff3b30;
      font-size: 13px;
      margin: 0 0 4px 0;
    }
    .stars {
      color: gold;
      margin: 4px 0;
    }
    .btn-row {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 6px;
    }
    .inquiry-btn {
      flex: 1;
      padding: 8px 12px;
      background: #25D366;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 14px;
      text-align: center;
    }
    .buy-btn {
      flex: 1;
      padding: 8px 12px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
    }
    .buy-btn[disabled] { opacity: 0.55; cursor: not-allowed; }
    .inquiry-btn:hover { background: #1ebe5d; }
    .buy-btn:hover { background: #0056b3; }
    a.back {
      display: block;
      margin: 15px 0;
      text-decoration: none;
      color: #27ae60;
      font-weight: bold;
    }
    /* Lightbox */
    .lightbox {
      display: none;
      position: fixed;
      z-index: 1200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }
    .lightbox img {
      max-width: 100%;
      max-height: 75%;
      border-radius: 10px;
      object-fit: contain;
    }
    .lightbox .caption {
      color: #fff;
      margin-top: 12px;
      font-size: 16px;
      text-align: center;
      max-width: 100%;
      word-break: break-word;
    }
    /* Cart icon */
    .cart-icon {
      position: fixed;
      top: 30px;
      right: 15px;
      font-size: 40px;
      cursor: pointer;
      color: white;
      z-index: 1300;
    }
    .cart-badge {
      position: absolute;
      top: 2px;
      right: 10px;
      background: red;
      color: white;
      font-size: 12px;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 50%;
      display: none;
    }

    /* small responsive tweak: ensure grid works on tiny screens */
    @media (max-width: 420px) {
      .product-grid { grid-template-columns: 1fr 1fr; gap:6px; padding:8px; }
      .product-card h3 { font-size: 13px; }
    }
  </style>
</head>
<body>

  <h1>Accent Chair</h1>
  <div id="count">Loading...</div>
  <div id="products" class="product-grid"></div>

  <a href="chair.html" class="back">â¬… Back to Categories</a>

  <!-- ðŸ›’ Cart Icon -->
  <div class="cart-icon" onclick="window.location.href='cart.html'">
    ðŸ›’<span id="cart-count" class="cart-badge">0</span>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <img id="lightbox-img" src="" alt="">
    <div id="lightbox-caption" class="caption"></div>
  </div>

  <script>
    // Expected sheet columns:
    // 0 Category | 1 Product Name | 2 Price | 3 Image Link | 4 region/type | 5 WhatsApp Link | 6 Discount Price | 7 Views/Rating

    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4YXFvxl_w447wVuWRrHv8EInZFg1lSIX2_KwxZQJL9n8YHEzIP5WmfBep4yBgfN7EbArsjPPHOzOh/pub?output=csv";

    // safe escapers
    function escapeAttr(s) { return String(s || "").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function escJS(s) { return String(s || "").replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\n/g,'\\n').replace(/\r/g,''); }
    function buildStars(n) { let out=""; for(let k=1;k<=5;k++) out += (k<=n) ? "â˜…" : "â˜†"; return out; }

    fetch(SHEET_CSV)
      .then(res => res.text())
      .then(data => {
        const rows = data.split("\n").slice(1);
        const container = document.getElementById("products");
        let count = 0;

        rows.forEach((row, i) => {
          const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
          if (!cols) return;

          const get = idx => (cols[idx] ? cols[idx].replace(/"/g, "").trim() : "");
          const category = get(0);
          const name = get(1);
          const price = get(2);
          const image = get(3);
          const type = get(4);
          const whatsapp = get(5);
          const discount = get(6);
          const viewsRaw = get(7);

          const catNorm = (category||"").trim().toLowerCase().replace(/\s+/g,'');
          const typeNorm = (type||"").trim().toLowerCase().replace(/\s+/g,'');

          if (catNorm === "accent" && typeNorm === "accent") {
            count++;

            // treat empty/whitespace or literal "sold" (case-insensitive) as sold
            const imageTrim = (image||"").trim();
            const isSoldMarker = imageTrim.toLowerCase() === "sold";
            const hasValidImage = imageTrim !== "" && !isSoldMarker;

            // image HTML
            let imageHtml = "";
            if (hasValidImage) {
              const imgEsc = escapeAttr(imageTrim);
              const imgJS = escJS(imageTrim);
              const nameJS = escJS(name);
              imageHtml = `<img src="${imgEsc}" alt="${escapeAttr(name)}" onclick="openLightbox('${imgJS}','${nameJS}')">`;
            } else {
              imageHtml = `<div class="sold" role="img" aria-label="SOLD">SOLD</div>`;
            }

            // price + discount (discount below, old crossed out in red)
            let priceHtml = "";
            if (discount && discount.trim() !== "") {
              priceHtml = `<div class="old-price">${escapeAttr(price)}</div><div class="price">${escapeAttr(discount)}</div>`;
            } else {
              priceHtml = `<div class="price">${escapeAttr(price)}</div>`;
            }

            // stars / rating
            let starsHtml = "";
            if (viewsRaw && viewsRaw.trim() !== "") {
              const parsed = parseInt(viewsRaw.trim());
              if (!isNaN(parsed)) {
                const clamped = Math.max(1, Math.min(5, parsed));
                starsHtml = `<div class="stars" id="rating-${i}" data-rating="${clamped}" data-name="${escapeAttr(name)}">${buildStars(clamped)}</div>`;
              } else {
                starsHtml = `<div class="stars" id="rating-${i}" data-rating="5" data-name="${escapeAttr(name)}">${buildStars(5)}<div style="color:#aaa;font-size:12px;">${escapeAttr(viewsRaw)}</div></div>`;
              }
            } else {
              starsHtml = `<div class="stars" id="rating-${i}" data-rating="5" data-name="${escapeAttr(name)}">${buildStars(5)}</div>`;
            }

            // inquiry href fallback logic (same behavior as before)
            const whatsappTrim = (whatsapp||"").trim();
            let inquiryHref = `https://wa.me/2347080535579?text=${encodeURIComponent("Hello, I'm interested in " + name + " (accent chair) priced at " + price)}`;
            if (whatsappTrim !== "") {
              if (whatsappTrim.startsWith("http") || whatsappTrim.startsWith("wa.me") || whatsappTrim.startsWith("https://") || whatsappTrim.startsWith("http://")) {
                inquiryHref = whatsappTrim;
              } else if (whatsappTrim.startsWith("+") || whatsappTrim.match(/^\d+$/)) {
                const number = whatsappTrim.replace(/\D/g, "");
                if (number) inquiryHref = `https://wa.me/${number}?text=${encodeURIComponent("Hello, I'm interested in " + name + " (accent chair) priced at " + price)}`;
              } else {
                inquiryHref = `https://wa.me/2347080535579?text=${encodeURIComponent(whatsappTrim)}`;
              }
            }

            // Add button: disabled when sold (so cannot add sold items)
            const addDisabled = hasValidImage ? "" : "disabled";
            const imageArgForAdd = hasValidImage ? escJS(imageTrim) : ""; // pass empty string if sold

            const card = `
              <div class="product-card">
                ${imageHtml}
                <h3>${escapeAttr(name)}</h3>
                ${priceHtml}
                ${starsHtml}
                <div class="btn-row">
                  <a class="inquiry-btn" href="${escapeAttr(inquiryHref)}" target="_blank">ðŸ“© Inquiry</a>
                  <button class="buy-btn" ${addDisabled} onclick="addToCart('${escJS(name)}','${escJS((discount && discount.trim() !== "") ? discount : price)}','${imageArgForAdd}')">ðŸ›’ Add</button>
                </div>
              </div>
            `;
            container.innerHTML += card;
          }
        });

        document.getElementById("count").textContent = `Total Accent Chairs Available: ${count}`;
        updateCartCount();
      });

    // LIGHTBOX + BACK handling
    // state flag on body.dataset.lightboxOpen ( '1' when open )
    function openLightbox(src, name) {
      if (!src || src.trim() === "") return;
      const lb = document.getElementById('lightbox');
      const img = document.getElementById('lightbox-img');
      const cap = document.getElementById('lightbox-caption');
      img.src = src;
      img.alt = name || "";
      cap.textContent = name || "";
      lb.style.display = "flex";
      lb.setAttribute('aria-hidden','false');

      if (document.body.dataset.lightboxOpen !== '1') {
        // push a history entry so browser back closes the lightbox
        try { history.pushState({lightbox:true}, ''); } catch(e) {}
        document.body.dataset.lightboxOpen = '1';
      }
    }

    function closeLightbox(initiatedByPopstate = false) {
      const lb = document.getElementById('lightbox');
      if (!lb || lb.style.display !== 'flex') return;
      lb.style.display = 'none';
      lb.setAttribute('aria-hidden','true');
      document.getElementById('lightbox-img').src = '';
      document.getElementById('lightbox-caption').textContent = '';

      if (document.body.dataset.lightboxOpen === '1') {
        document.body.dataset.lightboxOpen = '0';
        if (!initiatedByPopstate) {
          // pop the pushed history entry; popstate listener will not loop because we pass true when handling popstate
          try { history.back(); } catch(e) {}
        }
      }
    }

    // close on clicking outside image (but not when clicking the image itself)
    (function(){
      const lb = document.getElementById('lightbox');
      lb.addEventListener('click', function(e){
        if (e.target === lb) closeLightbox();
      });
    })();

    // handle browser back / popstate: if lightbox open, close it
    window.addEventListener('popstate', function(e){
      if (document.body.dataset.lightboxOpen === '1') {
        closeLightbox(true);
      }
    });

    // intercept the page Back link: if lightbox open, close it instead of navigating away
    (function(){
      const backLink = document.querySelector('a.back');
      if (backLink) {
        backLink.addEventListener('click', function(e){
          if (document.body.dataset.lightboxOpen === '1') {
            e.preventDefault();
            closeLightbox();
          }
          // else allow default navigation
        }, {passive:false});
      }
    })();

    // addToCart: now ignores sold items (image arg empty or whitespace)
    function addToCart(name, price, image) {
      if (!image || image.trim() === "") {
        // sold item â€” do nothing (button is disabled so this rarely runs)
        return;
      }
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      cart.push({ name, price, image });
      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount();

      // increment local star rating for the product (match by data-name)
      const els = document.querySelectorAll('.stars');
      for (let el of els) {
        if (el.getAttribute('data-name') === name) {
          let r = parseInt(el.getAttribute('data-rating')) || 0;
          r = Math.min(5, r + 1);
          el.setAttribute('data-rating', r);
          el.innerHTML = buildStars(r);
          break;
        }
      }
    }

    function updateCartCount() {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      const badge = document.getElementById("cart-count");
      if (cart.length > 0) {
        badge.style.display = "inline-block";
        badge.textContent = cart.length;
      } else {
        badge.style.display = "none";
      }
    }
  </script>

</body>
</html>